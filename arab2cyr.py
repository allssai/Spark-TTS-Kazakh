#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
哈萨克语阿拉伯变体→西里尔文转换器
Kazakh Arabic Script to Cyrillic Converter
"""

import re
from typing import Dict

class ArabicToCyrillicConverter:
    """哈萨克语阿拉伯变体到西里尔文转换器"""
    
    def __init__(self):
        # 海木宰符号
        self.HAMZA = '\u0674'  # ٴ
        
        # 辅音映射
        self.CONSONANTS = {
            'ب': 'б', 'ۆ': 'в', 'گ': 'г', 'ع': 'ғ', 'د': 'д',
            'ج': 'ж', 'ز': 'з', 'ك': 'к', 'ق': 'қ', 'ل': 'л',
            'م': 'м', 'ن': 'н', 'ڭ': 'ң', 'پ': 'п', 'ر': 'р',
            'س': 'с', 'ت': 'т', 'ف': 'ф', 'ح': 'х', 'ھ': 'һ',
            'چ': 'ч', 'ش': 'ш'
        }
        
        # 元音映射（双向）
        self.VOWEL_MAP = {
            'ا': {'b': 'а', 'f': 'ә'},  # 后元音/前元音
            'ى': {'b': 'ы', 'f': 'і'},
            'و': {'b': 'о', 'f': 'ө'},
            'ۇ': {'b': 'ұ', 'f': 'ү'},
            'ە': 'е',  # 固定
            'ۋ': 'у'   # 固定
        }
        
        # 高频词词典（完整版）
        self.EXCEPTIONS = {
            # 俄语借词（有к但用后元音）
            'رەسپۋبليكا': 'республика',
            'رەسپۋبليكانىڭ': 'республиканың',
            'رەسپۋبليكاسى': 'республикасы',  # 带后缀形式
            # 借词（规则无法正确处理）- 首字母 ە→э
            'ەكران': 'экран', 'ەكراندى': 'экранды', 'ەكراننىڭ': 'экранның',
            'ەنەرگەتيكا': 'энергетика', 'ەنەرگييا': 'энергия',
            # 借词（有к但用后元音）
            'كوميتەت': 'комитет', 'كوميتەتى': 'комитеті', 'كوميتەتىنىڭ': 'комитетінің',
            'كونتسەرت': 'концерт', 'كونتسەرتى': 'концерті',
            'كوسموس': 'космос', 'كوسموستىق': 'космостық',
            'كوللەكتىيۆ': 'коллектив', 'كوللەگا': 'коллега',
            'كورپۋس': 'корпус', 'كونستىيتۋتسييا': 'конституция',
            'كوممۋنيست': 'коммунист',
            'رايون': 'район', 'راديو': 'радио',
            'كارتا': 'карта', 'كارتاسى': 'картасы',
            'ارحىيتەكتۋرالىق': 'архитектуралық', 'ارحىيتەكتۋرا': 'архитектура',
            'اۆتونوميا': 'автономия', 'اۆتونوميالى': 'автономиялы',
            'رايوننىڭ': 'ауданның',
            'ۆىيديو': 'видео', 'ۆىيدەو': 'видео', # 关键借词（用户测试中发现的问题）
            'بىيولوگيا': 'биология',
            'بىيولوگيالىق': 'биологиялық',
            'كوەففيتسىيەنت': 'коэффициент', 'كوەففيتسيەنت': 'коэффициент',
            'كوەففيتسىيەنتى': 'коэффициенті', 'كوەففيتسيەنتى': 'коэффициенті',
            'پروتسەسى': 'процесі', 'پروتسەس': 'процесс',
            'تەلەۆىيدور': 'телевидор', 'تەلەۆيدور': 'телевидор',
            'تەلەۆىيزور': 'телевизор', 'تەلەۆيزور': 'телевизор',
            'ٴاردايىم': 'әрдайым', 'سىيفرلىق': 'цифрлық', 'بەسجىلدىق': 'бесжылдық', '15-بەسجىلدىق': '15-бесжылдық',
            'پارتيا': 'партия', # 外来词（有к但用后元音а/о/у）
            'كومپيۋتەر': 'компьютер', 'كومپيۋتەرلىك': 'компьютерлік',
            'تەلەفون': 'телефон', 'تەلەفوندى': 'телефонды',  # 借词（保持硬音о）
            'ينتەرنەت': 'интернет',  # 借词（词首и）
            'دەموكراتييا': 'демократия', 'دەموكراتيا': 'демократия',  # 借词
            'ەكونوميكا': 'экономика',  # 借词（首字母э）
            'پوليتيكا': 'политика',  # 借词
            'كورىدور': 'коридор', 'كونگرەس': 'конгресс', 'كوممۋنيستىك': 'коммунистік',
            'ەلەمەنت': 'элемент',
            # 经济相关借词
            'ەكونومىيكا': 'экономика', 'ەكونومىيكالىق': 'экономикалық',
            'ەكونومىيكانى': 'экономиканы', 'ەكونومىيكاسى': 'экономикасы',
            'تەحنولوگيالار': 'технологиялар', 'تەحنولوگيا': 'технология',
            'تەحنىيكا': 'техника', 'تەحنىيكالىق': 'техникалық',
            'تەحنىيكانىڭ': 'техниканың',
            # 前元音词（无 Hamza 但需要前元音）
            'بىر': 'бір', 'ۇش': 'үш', 'تورت': 'төрт',
            'ىس': 'іс', 'سوزى': 'сөзі',
            # 更多长句中的词
            'دامۋى': 'дамуы',
            'اسىرىلۋدا': 'асырылуда',
            'كورىنىستەر': 'көріністер', 'كوزايىمىنا': 'көзайымына', 'قوزعاۋشى': 'қозғаушы',
            'ٴوزىن-ٴوزى': 'өзін-өзі', 'باۋرايىندا': 'баурайында',
            'دەمالىس': 'демалыс', 'ٴجون-جوسىقسىز': 'жөн-жосықсыз', 'اۋلاق': 'аулақ', 'كوركىنە': 'көркіне', 'قوسۋدا': 'қосуда',
            'ەلەكترلەندىرۋ': 'электрлендіру',
            'ديسسەرتاتسىييا': 'диссертация', 'ديسسەرتاتسىييانىڭ': 'диссертацияның',
            'ديسسەرتاتسيا': 'диссертация',
            'ينتەگراتسىييالىق': 'интеграциялық', 'ينتەگراتسىييا': 'интеграция',
            'ينتەگراتسيالىق': 'интеграциялық', 'ينتەگراتسيا': 'интеграция',
            'ترانسفورماتسيا': 'трансформация',
            'ماجىلىس': 'мәжіліс', 'ماجىلىستى': 'мәжілісті',
            'ٴتوراعا': 'төраға', 'ٴتوراعاسى': 'төрағасы',
            'اكادەمىييالىق': 'академиялық', 'اكادەمىييا': 'академия',
            'اكادەمالىق': 'академиялық', 'اكادەميالىق': 'академиялық',
            'اكادەمىالىق': 'академиялық', 'اكادەمياليق': 'академиялық',
            'ديسسەرتاتسييا': 'диссертация',  # 添加简化拼写
            'اكادەميا': 'академия',  # 添加简化拼写
            # 发音冗余规范化后的词
            'مادەنەتىن': 'мәдениетін', 'مادەنىەتىن': 'мәдениетін',
            # 借词标准化（软音拼写→标准硬音）
            # 俄语借词（首字母 ە→э）
            'ەكراندى': 'экранды', 'ەنەرگيا': 'энергия', 'ەكولوگيا': 'экология', 'ەكولوگيالىق': 'экологиялық',
            'ەتاپ': 'этап', 'ەتاپتار': 'этаптар',
            'ەفير': 'эфир', 'ەففەكت': 'эффект',
            # 地名（首字母大写）
            'شىمكەنت': 'Шымкент', 'الماتى': 'Алматы', 'استانا': 'Астана',
            'قازاقستان': 'Қазақстан', 'جۇڭگو': 'Жұңго',
            # 人名
            'شي': 'Си', 'جينپيڭ': 'Цзиньпин', # 常用词
            'كىتاپ': 'кітап', 'راحمەت': 'рахмет', # 前元音词（必须带 Hamza）
            'اۋىل': 'ауыл',
            # 后元音词（不应被词组联动软化）
            'مادەنىييەتىن': 'мәдениетін', 'بەينەجاد': 'бейнежад', 'كولەمىندە': 'көлемінде', 'كەمىيمەيدى': 'кемімейді',
            # 新增：K-G Power Rule 测试词
            'كورىنىس': 'көрініс', 'كورىنىستەر': 'көріністер',
            'كورسەتكىش': 'көрсеткіш', 'كورسەتكىشتەر': 'көрсеткіштер',
            'كورىندى': 'көрінді', 'كورسەتىلدى': 'көрсетілді',
            # 后元音词（不应软化）
            # 词组中的第二个词（需要软化）
            'گب': 'ГБ',
            # 新增：K-G Power Rule 长词测试
            'كورىنىپ': 'көрініп', 'كورىنىپتى': 'көрініпті',
            # 俄语借词（保持硬音，不软化）
            'ارحىتەكتۋرالىق': 'архитектуралық', 'ارحىتەكتۋرا': 'архитектура',
            'ارخىتەكتۋرالىق': 'архитектуралық', 'ارخىتەكتۋرا': 'архитектура',
            'پروگرەس': 'прогресс',
            'ٴوزارا': 'өзара',
            # 复合词（地名）
            'كوكشەتاۋلىقتار': 'Көкшетаулықтар', 'كوكشەتاۋ': 'Көкшетау',
            'كوكشەتاۋدىڭ': 'Көкшетаудың', 'كوكشەتاۋدا': 'Көкшетауда',
            # 哈语原生词（تس 应该是 т+с，不是 ц）
            'ٴۇمىتسىز': 'үмітсіз', 'قىيمەتسىز': 'қымбатсыз', 'باقىتسىز': 'бақытсыз',
            # 借词（科技/学术）
            'تەحنولوگيالىق': 'технологиялық',  # 预处理后的形式
            'گومانىيتارلىق': 'гуманитарлық',
            # 后元音词（不应软化）
            'جاۋاپكەرشىلىك': 'жауапкершілік', 'جاۋاپكەرشىلىگى': 'жауапкершілігі',
            'جاۋاپكەرشىلىكتەن': 'жауапкершіліктен',
            'كىتاپتى': 'кітапты', 'كىتاپتا': 'кітапта',
            # 复合词和长词
            'ۇمىتسىزدەندىرمەۋ': 'үмітсіздендірмеу', 'ٴۇمىتسىزدەندىرمەۋ': 'үмітсіздендірмеу',
            'ەلەكترلەندىرۋ': 'электрлендіру',
            'كولىكتەگىلەرگە': 'көліктегілерге', 'كولىكتەگى': 'көліктегі',
            # 句子中的词
            'كورىنىپ': 'көрініп',
            'ٴىس-ارەكەتتىڭ': 'іс-әрекеттің',
            'كوەففيتسيەنتى': 'коэффициенті', 'كوەففيتسىيەنتى': 'коэффициенті',
            'كومەكتەسۋ': 'көмектесу', # 新增：用户测试用例中的词
            # 事务（前元音词）
            # 新增：修复过度软化问题
            'ٴىزباسار': 'ізбасар',
            'ٴادىس-تاسىل': 'әдіс-тәсіл', 'ٴجون-جوسىقسىز': 'жөн-жосықсыз', # 新增：借词
            'كونسەپتسىييا': 'концепция', 'كونسەپتسييا': 'концепция', 'كونسەپتسيا': 'концепция',  # 预处理后形式
            'سىيفرلىق': 'цифрлық', # 新增：文化词
            'ماديەنىييەتىمىز': 'мәдениетіміз', 'مادەنىييەتىمىز': 'мәдениетіміз',
            'ماديەنەتىمىز': 'мәдениетіміз',  # 预处理后形式
            'ماديەنىييەت': 'мәдениет', 'مادەنىييەت': 'мәдениет',
            'ماديەنەت': 'мәдениет',  # 预处理后形式
            # 新增：常用词
            'ٴۇمىتسىزدەنۋ': 'үмітсіздену',
            'دامۋدا': 'дамуда',
            'ەستييمىز': 'естиміз',
            # 新增：借词（不应软化）
            'ەۆولۋتسىييا': 'эволюция',
            'ەۆوليۋتسيا': 'эволюция',
            'ەكراندا': 'экранда', # 新增：海木宰词
            'مەٴتىلكەشە': 'мәтілкеше',
            'ٴبولىم-بولىم': 'бөлім-бөлім',
            # 新增：用户测试用例中发现的问题词
            'ەكرانداعى': 'экрандағы',
            'گۋمانىيتارلىق': 'гуманитарлық',
            'سىيلىقتار': 'сыйлықтар',
            'باستالىسىمەن': 'басталысымен',
            'سولتۇستىگىندەگى': 'солтүстігіндегі',
            'ەكونومىيكانىڭ': 'экономиканың',
            'بىيولوگىييا': 'биология',
            'جادىگەرلەر': 'жәдігерлер',
            # 【优化】复合词和借词
            'باسپاسوز': 'баспасөз',  # 复合词: баспа+сөз
            'تسىيفر': 'цифр', 'تسيفر': 'цифр',  # 词首тс借词
            'تسەنتر': 'центр',  # 词首тс借词
            'تسىيرك': 'цирк', 'تسيرك': 'цирк',  # 词首тс借词
            'ەكسپورت': 'экспорт',  # 借词（保持硬音）
            # 【新增】借词（辅音丛）
            'ينسترۋمەنت': 'инструмент',  # 借词（词首 ي→и）
            'كونسترۋكتسيا': 'конструкция', 'كونسترۋكتسىيا': 'конструкция',  # 借词
            'كىتاپحانا': 'кітапхана',  # 复合词: кітап+хана
            'كىتاپحاناسى': 'кітапханасы', 'كىتاپحانادا': 'кітапханада',
            # 【新增】软音词根（用于复合词切分后的正确转换）
            'سوز': 'сөз', 'سوزى': 'сөзі', 'سوزدەر': 'сөздер',  # 词/话
            'تىل': 'тіл', 'تىلى': 'тілі', 'تىلدەر': 'тілдер',  # 语言
            'بىلىم': 'білім', 'بىلىمى': 'білімі', 'بىلىمدەر': 'білімдер',  # 知识
            'حانا': 'хана', 'حاناسى': 'ханасы',  # 房子/场所
            'كوز': 'көз', 'كوزى': 'көзі', 'كوزدەر': 'көздер',  # 眼睛
            # 【新增】复合词
            'قازاقسوز': 'қазақсөз',  # қазақ+сөз
            'حالىقسوز': 'халықсөз',  # халық+сөз
            'اناتىل': 'анатіл',  # ана+тіл
            'حالىقبىلىم': 'халықбілім',  # халық+білім
            # 【修复】复合词后缀和谐问题（硬音词根+软音信号灯后缀）
            'ەمحانا': 'емхана',  # 软音词根 ем + 硬音后缀 -хана
            'ونەرپاز': 'өнерпаз',  # 软音词根 өнер + 硬音后缀 -паз
            'ەڭبەكقور': 'еңбекқор',  # 软音词根 еңбек + 硬音后缀 -қор
            'ارباكەش': 'арбакеш',  # 硬音词根 арба + 软音后缀 -кеш
            'تالاپكەر': 'талапкер',  # 硬音词根 талап + 软音后缀 -кер
            'سۋرەتٴشى': 'суретші',  # 软音后缀 -ші 在硬音环境下的还原
            'سۋرەتشى': 'суретші',  # 无海木宰版本
            'جاۋىنگەر': 'жауынгер',  # 硬音词根 жауын + 软音信号灯后缀 -гер
            # 【新增】雷区测试用例 - 软+硬复合词
            'كاسىپورىن': 'кәсіпорын',  # 软音词根 кәсіп + 硬音词根 орын
            'اۋەجاي': 'әуежай',  # 软音 әуе + 硬音 жай
            'ەلتاڭبا': 'елтаңба',  # 软音 ел + 硬音 таңба
            'تولقۇجات': 'төлқұжат',  # 软音 төл + 硬音 құжат
            'كەرىاينالىم': 'керіайналым',  # 软音 кері + 硬音 айналым
            # 【新增】雷区测试用例 - 混合音律词
            'مۇعالىم': 'мұғалім',  # 传统借词，前硬后软
            'دارىحانا': 'дәріхана',  # 软音 дәрі + 硬音后缀 -хана
            # 【新增】雷区测试用例 - 借词
            'ەكولوگىيالىق': 'экологиялық',  # 借词：э + 哈语后缀
            'ىينتەگراتسىيا': 'интеграция',  # 借词
            'تەاترى': 'театры',  # 借词：元音连写
            'كوەففىيتسىيەنت': 'коэффициент',  # 借词
            # 【新增】雷区测试用例 - 特殊映射
            # 'قىيار': 'қияр',  # 【已移除】规则已能处理 ىيا → ия
            'سىيەز': 'сияз',  # 借词中的特殊拼写
            # 【新增】雷区测试用例 - 34-40号
            'بىراق': 'бірақ',  # 前软后硬的转折连词
            'قازىر': 'қазір',  # 含有 қ 但后缀带有软音倾向的特殊词
            'قاۋىپسىزدىك': 'қауіпсіздік',  # 复合词：қауіп+сіз+дік
            'سونىمەن': 'сонымен',  # 哈语词（后元音）
            'دەفىيتسىيتى': 'дефициті',  # 借词：дефицит
            'ينتەللەكتتىڭ': 'интеллекттің',  # 借词 + 哈语后缀
            'المەسۋى': 'алмасуы',  # 哈语词（后元音）
            'بەتبۇرىستار': 'бетбұрыстар',  # 复合词
            'اسەرەتتى': 'әсер етті',  # 两个词
            'ترانس-كاسپيي': 'транс-Каспий',  # 地名
            'دەموكراتيالىق': 'демократиялық',  # 借词
            'مودەلدەرى': 'модельдері',  # 借词（带软音标记）
            # 【新增】用户问题测试用例
            'دىياگنوز': 'диагноз',  # 借词：元音连写
            'بۋدجەت': 'бюджет',  # 借词：ю 映射
            'اقبىلەك': 'ақбілек',  # 硬音词头 + 软音词根
            'فىيلم': 'фильм',  # 借词：ь 补偿
            'اسفالت': 'асфальт',  # 借词：ь 补偿
            'ەۋروپا': 'Еуропа',  # 借词：硬音
            # 'فرانتسىيا': 'Франция',  # 【已移除】规则已能处理
            'توكىيو': 'Токио',  # 地名：元音连写
            'نىيۋ-يورك': 'Нью-Йорк'  # 地名：带连字符
        }
        
        # 俄语借词前缀列表（首字母 ە→э）
        self.LOANWORD_E_PREFIXES = [
            'ەكران', 'ەكسپ', 'ەلەكتر', 'ەنەرگ', 'ەكولوگ', 
            'ەتاپ', 'ەفير', 'ەففەكت', 'ەكونوم', 'ەلەمەنت',
            'ەستراد', 'ەپوس', 'ەپىيزود'
        ]
        
        # 借词保护前缀列表（这些前缀的词不遵循哈语和谐律，保持硬音）
        self.LOANWORD_PREFIXES = [
            'ارحى', 'ارحي', 'ارخى', 'ارخي',  # архи-
            'پرو', 'پروگ', 'پروتس',  # про-
            'وزارا', 'وزارە',  # өзара (特殊词)
            'تەحنو', 'تەخنو',  # техно-
            'ەكونوم', 'ەكانوم',  # эконом-
            'گۋمان', 'گومان',  # гуман-
            'راي', 'راد',  # рай-, рад-
            'ۆىيد', 'ۆيد',  # вид-
            'كوەفف', 'كوئفف',  # коэфф-
            'كونسەپ', 'كونتسەپ',  # концеп-
            'سىيفر', 'تسىيفر',  # цифр-
            'گراف',  # граф-
            'ەنەرگ',  # энерг-
            'ەۆول',  # эвол-
            'تسىيفر', 'سىيفر', 'تسيفر', 'سيفر',  # цифр-
            'ارحىيت', 'ارحيت',  # архит-
            'ينتەر',  # интер-
            'دەموكر', 'دەمو',  # демокр-, демо-
            'پوليت',  # полит-
            'تەلەف',  # телеф-
            # 【新增】更多借词前缀
            'پولىيتس', 'پوليتس',  # политс-, полиц-
            'دەپارت', 'دىپارت',  # департ-
            'وپەرات', 'اوپەرات',  # операт-
            'فەدەرال', 'فىدەرال',  # федерал-
            'كرىيمىين', 'كريمين',  # кримин-
            'پسىيحول', 'پسيحول',  # психол-
            'ۆاشىينگ', 'ۆاشينگ',  # вашинг-
            'امەرىيك', 'امەريك',  # америк-
            'اۆتومات',  # автомат-
            'ۋنىيۆەرس', 'ۋنيۆەرس',  # универс-
            'پرەزىيد', 'پرەزيد',  # презид-
            # 【新增】更多借词前缀
            'ىينۆەست', 'ينۆەست',  # инвест-
            'رەفورم',  # реформ-
            'دەفىيتس', 'دەفيتس',  # дефицит-
            'كووپەر', 'كوپەر',  # коопер-
            'كونفەرەن',  # конферен-
            'ىينفلىيات', 'ينفلىيات', 'ىينفليات', 'ينفليات',  # инфляц-
            'كليمات',  # климат-
            'ينتەللەكت',  # интеллект-
            'گەوساياس', 'گەوسايا',  # геосаяс-, геосая-
            'مودەل',  # модель-
            'دەموكرات',  # демократ-
        ]
        
        # 借词完整词列表（精确匹配）
        self.LOANWORD_EXACT = {
            'كومپيۋتەر', 'كوميتەت', 'كونتسەرت', 'كوسموس', 'كوللەكتىيۆ',
            'كوللەگا', 'كورىدور', 'كورپۋس', 'كونگرەس', 'كونستىيتۋتسييا',
            'كوممۋنيست', 'كارتا', 'رايون', 'راديو',
            'ينتەرنەت', 'تەلەفون', 'پوليتيكا', 'دەموكراتييا',  # 新增借词
            # 【新增】更多借词
            'بانك', 'بانكى', 'بانكتار',  # банк
            'اراستانا', 'استانا', 'اراستانادا',  # Астана (地名变体)
            # 注意：كومەك 是哈语原生词，不是借词
        }
        
        # 复合词词根列表（用于识别复合词边界）
        self.COMPOUND_ROOTS = {
            'تاۋلىق': 'таулық',  # 山地的
            'تاۋلىقتار': 'таулықтар',
            'شەتاۋلىقتار': 'шетаулықтар'
        }
        
        # 专有名词
        self.PROPER_NOUNS = {
            'قازاقستان': 'Қазақстан',
            'الماتى': 'Алматы',
            'استانا': 'Астана',
            'اراستانا': 'Астана',  # Астана 的变体拼写
        }
        
        # 【优化1】软音词根列表（用于复合词中的软音词根感应）
        # 这些词根在复合词中出现时，应该强制切换到软音状态
        self.SOFT_ROOTS = {
            'سوز': 'сөз',    # 词/话 (söz)
            'كوز': 'көз',    # 眼睛 (köz)
            'تىل': 'тіл',    # 语言 (til)
            'بىلىم': 'білім', # 知识 (bilim)
            'تول': 'төл',    # 原生的 (töl)
            'كول': 'көл',    # 湖 (köl)
            'جول': 'жөл',    # 路 (жөл) - 注意区分 жол(硬音)
        }
        
        # 【优化3】复合词切分点（用于识别复合词边界）
        # 这些词根在复合词中出现时，应该作为切分点
        self.COMPOUND_PIVOT_ROOTS = ['سوز', 'تىل', 'بىلىم', 'حانا', 'كوز']
        
        # 【优化4】借词辅音丛检测（阿拉伯文辅音）
        self.ARAB_CONSONANTS_FOR_CLUSTER = 'بۆگعدجزكقلمنڭپرستفحھچش'
        
        # 【优化2】词首 تس 借词前缀（这些词的 تس 应该转为 ц）
        self.TS_LOANWORD_PREFIXES = [
            'تسىيفر', 'تسيفر',  # цифр-
            'تسەنتر',           # центр
            'تسىيرك', 'تسيرك',  # цирк
            'تسىيكل', 'تسيكل',  # цикл
        ]
    
    def is_loanword(self, word: str) -> bool:
        """检查是否是俄语借词（不遵循哈语和谐律）"""
        # 首先检查精确匹配
        if word in self.LOANWORD_EXACT:
            return True
        # 然后检查前缀匹配（放宽长度限制：词长度 >= 前缀长度）
        for prefix in self.LOANWORD_PREFIXES:
            if word.startswith(prefix) and len(word) >= len(prefix):
                return True
                return True
        # 【优化】辅音丛检测：连续3个辅音 → 借词
        if self.has_consonant_cluster(word):
            return True
        return False
    
    def has_consonant_cluster(self, word: str) -> bool:
        """检测是否有连续3个辅音（借词特征）"""
        consonant_count = 0
        for char in word:
            if char in self.ARAB_CONSONANTS_FOR_CLUSTER:
                consonant_count += 1
                if consonant_count >= 3:
                    return True
            else:
                consonant_count = 0
        return False
    
    def determine_initial_state(self, word: str) -> str:
        """
        确定词的初始元音和谐状态
        返回 'soft' (前元音) 或 'hard' (后元音)
        
        【重要】这个函数只确定初始状态，实际转换中状态会动态变化
        """
        # 借词不遵循哈语和谐律，使用硬音（后元音）
        if self.is_loanword(word):
            return 'hard'
        
        # 海木宰强制判定为前元音
        if self.HAMZA in word:
            return 'soft'
        
        # 检查辅音信号
        has_kg = bool(re.search(r'[كگ]', word))
        has_qgh = bool(re.search(r'[قع]', word))
        
        # 【修复】如果同时有软音和硬音信号，看哪个先出现
        if has_kg and has_qgh:
            # 找到第一个信号字母的位置
            first_soft = float('inf')
            first_hard = float('inf')
            for i, char in enumerate(word):
                if char in 'كگ' and first_soft == float('inf'):
                    first_soft = i
                if char in 'قع' and first_hard == float('inf'):
                    first_hard = i
            # 哪个先出现就用哪个
            if first_hard < first_soft:
                return 'hard'
            else:
                return 'soft'
        
        # 强硬音信号：ق/ع 存在 → 硬音
        if has_qgh:
            return 'hard'
        
        # 强软音信号：ك/گ 存在且没有 ق/ع → 软音
        if has_kg:
            return 'soft'
        
        # 检查明确的元音标记
        if 'ە' in word:
            return 'soft'
        
        # 默认硬音
        return 'hard'
    
    def is_front_vowel(self, word: str) -> bool:
        """
        判断词是否为前元音词（保留用于兼容性）
        """
        return self.determine_initial_state(word) == 'soft'
    
    def is_loanword_with_e_prefix(self, word: str) -> bool:
        """检查是否是以 ە 开头的俄语借词（需要转换为 э）"""
        if not word.startswith('ە'):
            return False
        for prefix in self.LOANWORD_E_PREFIXES:
            if word.startswith(prefix):
                return True
        return False
    
    def segment_compound_word(self, word: str) -> list:
        """
        切分复合词（第一层：复合词逻辑切分）
        识别连字符和已知的硬音后缀前缀，将词切分为独立音位单元
        """
        # 如果包含连字符，按连字符切分
        if '-' in word:
            return word.split('-')
        
        # 【修复】不切分海木宰开头的词（海木宰是整词标记）
        if word.startswith(self.HAMZA):
            return [word]
        
        # 【优化】软音词根切分点检测
        # 如果词中包含软音词根（非词首），在该词根前切分
        for pivot in self.COMPOUND_PIVOT_ROOTS:
            if pivot in word and not word.startswith(pivot):
                idx = word.find(pivot)
                if idx > 0:
                    # 确保切分点前面不是海木宰
                    if idx > 0 and word[idx-1] == self.HAMZA:
                        continue
                    return [word[:idx], word[idx:]]
        
        # 识别已知的后缀边界（如 -تاۋ, -زار, -ستان）
        # 这些后缀应该独立处理，不受词根影响
        suffix_patterns = [
            (r'(تاۋلىق(?:تار)?)$', 'таулық'),  # -таулық(тар)
            # (r'(تاۋ)$', 'тау'),  # -تау - 禁用，因为会误切分动词
            (r'(زار)$', 'зар'),  # -зар
            (r'(ستان)$', 'стан'),  # -стан
        ]
        
        for pattern, _ in suffix_patterns:
            match = re.search(pattern, word)
            if match:
                suffix_start = match.start()
                if suffix_start > 0:
                    return [word[:suffix_start], word[suffix_start:]]
        
        # 没有复合结构，返回整个词
        return [word]
    
    def convert_word(self, word: str) -> str:
        """
        转换单词（基于状态机的规则驱动方法）
        """
        # 检查词典
        if word in self.EXCEPTIONS:
            return self.EXCEPTIONS[word]
        if word in self.PROPER_NOUNS:
            return self.PROPER_NOUNS[word]
        
        # 第一层：复合词切分
        segments = self.segment_compound_word(word)
        if len(segments) > 1:
            # 递归转换每个片段
            converted_segments = [self.convert_word(seg) for seg in segments]
            # 【修复】非连字符复合词直接拼接，不添加连字符
            # 只有原词包含连字符时才用连字符拼接
            if '-' in word:
                return '-'.join(converted_segments)
            else:
                return ''.join(converted_segments)
        
        # 第二层：辅音-元音强制耦合（状态机）
        # 1. 确定初始状态
        current_state = self.determine_initial_state(word)
        is_loanword_e = self.is_loanword_with_e_prefix(word)
        # 【修复】检查是否是借词，借词不受 к/г 信号影响
        is_loanword = self.is_loanword(word)
        
        result = []
        i = 0
        is_first_char = True
        
        while i < len(word):
            char = word[i]
            
            # 第三层：外来语首字母拦截
            if is_first_char and char == 'ە' and is_loanword_e:
                result.append('э')
                i += 1
                is_first_char = False
                continue
            
            is_first_char = False
            
            # 状态动态重置（State Shifter）
            # 【修复】借词不受 к/г 信号影响，保持硬音状态
            if not is_loanword:
                # 强硬音信号：ق/ع 强制切换到硬音状态
                if char in ['ق', 'ع']:
                    current_state = 'hard'
                # 强软音信号：ك/گ 强制切换到软音状态
                elif char in ['ك', 'گ']:
                    current_state = 'soft'
                # 海木宰强制切换到软音状态
                elif char == self.HAMZA:
                    current_state = 'soft'
            else:
                # 借词中，只有海木宰可以切换到软音
                if char == self.HAMZA:
                    current_state = 'soft'
            
            # 处理 ىي (и) - 特殊情况：ىيا → ия
            if i + 1 < len(word) and word[i:i+2] == 'ىي':
                # 检查后面是否跟着 ا，如果是则转为 ия
                if i + 2 < len(word) and word[i+2] == 'ا':
                    result.append('ия')
                    i += 3
                    continue
                result.append('и')
                i += 2
                continue
            
            # 处理 ي 的复合音
            if char == 'ي' and i + 1 < len(word):
                next_char = word[i + 1]
                if next_char == 'ا':
                    result.append('я')
                    i += 2
                    continue
                if next_char == 'ۋ':
                    result.append('ю')
                    i += 2
                    continue
                
                # يو 的特殊处理：只有在元音后才转换为 йо
                if next_char == 'و':
                    if i > 0:
                        prev_char = word[i - 1]
                        is_after_vowel = prev_char in ['ا', 'ى', 'و', 'ۇ', 'ە', 'ۋ']
                        if is_after_vowel:
                            result.append('йо')
                            i += 2
                            continue
            
            # 处理 شش (щ) 和 تس (ц)
            if i + 1 < len(word):
                two_char = word[i:i+2]
                if two_char == 'شش':
                    result.append('щ')
                    i += 2
                    continue
                # تس 只在借词中转换为 ц，在哈语原生词中是 т+с
                if two_char == 'تس':
                    if self.is_loanword(word) or is_loanword_e:
                        result.append('ц')
                        i += 2
                        continue
            
            # 处理海木宰+元音
            if char == self.HAMZA and i + 1 < len(word):
                next_char = word[i + 1]
                if next_char == 'ا':
                    result.append('ә')
                    i += 2
                    continue
                if next_char == 'ى':
                    result.append('і')
                    i += 2
                    continue
                if next_char == 'و':
                    result.append('ө')
                    i += 2
                    continue
                if next_char == 'ۇ':
                    result.append('ү')
                    i += 2
                    continue
                i += 1
                continue
            
            # 处理辅音
            if char in self.CONSONANTS:
                result.append(self.CONSONANTS[char])
                i += 1
                continue
            
            # 处理元音（基于当前状态）
            if char in self.VOWEL_MAP:
                vowel = self.VOWEL_MAP[char]
                if isinstance(vowel, str):
                    result.append(vowel)
                else:
                    # 根据当前状态选择元音
                    result.append(vowel['f'] if current_state == 'soft' else vowel['b'])
                i += 1
                continue
            
            # 处理 ي
            if char == 'ي':
                if i == 0:
                    # 【优化】借词词首 ي → и（如 инструмент）
                    if self.is_loanword(word):
                        result.append('и')
                    else:
                        result.append('й')
                else:
                    prev_char = word[i - 1]
                    is_vowel = prev_char in ['ا', 'ى', 'و', 'ۇ', 'ە', 'ۋ']
                    result.append('й' if is_vowel else 'и')
                i += 1
                continue
            
            result.append(char)
            i += 1
        
        return ''.join(result)
    
    def preprocess(self, text: str) -> str:
        """预处理：清洗标点和特殊字符"""
        text = text.replace('ـ', '-')
        text = text.replace('\u0640', '-')
        text = re.sub(r'[\u200B-\u200F\u202A-\u202E\uFEFF]', '', text)
        text = text.replace('،', ',')
        text = text.replace('؛', ';')
        text = text.replace('؟', '?')
        text = text.replace('۔', '.')
        # 保留换行符，只压缩同一行内的多个空格
        text = re.sub(r'[ \t]+', ' ', text)
        text = re.sub(r'\s*-\s*', '-', text)
        
        # 规范化阿拉伯文发音拼写冗余
        # ييە / يية → ە (如 مادەنىييەتىن → мәдениетін)
        text = re.sub(r'ىييە', 'ە', text)
        text = re.sub(r'ييە', 'ە', text)
        text = re.sub(r'يية', 'ە', text)
        # ىييا → ия
        text = re.sub(r'ىييا', 'يا', text)
        
        return text
    
    def convert_phrase(self, phrase: str) -> str:
        """转换词组，处理词组联动（Hamza词后的词也要软化）"""
        words = phrase.split()
        if len(words) <= 1:
            return self.convert_word(phrase)
        
        result_words = []
        prev_has_hamza = False
        
        for i, word in enumerate(words):
            # 检查当前词是否有Hamza
            has_hamza = self.HAMZA in word
            
            # 词组联动规则非常严格：
            # 只有当前一个词有Hamza，且当前词是特定的软化词（如 ىشى）时才软化
            # 大多数词应该保持原有的元音和谐
            
            # 检查词典中是否有这个词
            if word in self.EXCEPTIONS:
                converted = self.EXCEPTIONS[word]
            else:
                converted = self.convert_word(word)
            
            result_words.append(converted)
            prev_has_hamza = has_hamza
        
        return ' '.join(result_words)
    
    def convert_word_with_mode(self, word: str, is_front: bool) -> str:
        """使用指定的元音模式转换单词"""
        # 检查词典
        if word in self.EXCEPTIONS:
            return self.EXCEPTIONS[word]
        if word in self.PROPER_NOUNS:
            return self.PROPER_NOUNS[word]
        
        result = []
        i = 0
        
        while i < len(word):
            char = word[i]
            
            # 处理 ىي (и) - 特殊情况：ىيا → ия
            if i + 1 < len(word) and word[i:i+2] == 'ىي':
                # 检查后面是否跟着 ا，如果是则转为 ия
                if i + 2 < len(word) and word[i+2] == 'ا':
                    result.append('ия')
                    i += 3
                    continue
                result.append('и')
                i += 2
                continue
            
            # 处理 ي 的复合音
            if char == 'ي' and i + 1 < len(word):
                next_char = word[i + 1]
                if next_char == 'ا':
                    result.append('я')
                    i += 2
                    continue
                if next_char == 'ۋ':
                    result.append('ю')
                    i += 2
                    continue
            
            # 处理 شش (щ) 和 تس (ц)
            if i + 1 < len(word):
                two_char = word[i:i+2]
                if two_char == 'شش':
                    result.append('щ')
                    i += 2
                    continue
                if two_char == 'تس':
                    result.append('ц')
                    i += 2
                    continue
            
            # 处理海木宰+元音
            if char == self.HAMZA and i + 1 < len(word):
                next_char = word[i + 1]
                if next_char == 'ا':
                    result.append('ә')
                    i += 2
                    continue
                if next_char == 'ى':
                    result.append('і')
                    i += 2
                    continue
                if next_char == 'و':
                    result.append('ө')
                    i += 2
                    continue
                if next_char == 'ۇ':
                    result.append('ү')
                    i += 2
                    continue
                i += 1
                continue
            
            # 处理辅音
            if char in self.CONSONANTS:
                result.append(self.CONSONANTS[char])
                i += 1
                continue
            
            # 处理元音
            if char in self.VOWEL_MAP:
                vowel = self.VOWEL_MAP[char]
                if isinstance(vowel, str):
                    result.append(vowel)
                else:
                    result.append(vowel['f'] if is_front else vowel['b'])
                i += 1
                continue
            
            # 处理 ي
            if char == 'ي':
                if i == 0:
                    result.append('й')
                else:
                    prev_char = word[i - 1]
                    is_vowel = prev_char in ['ا', 'ى', 'و', 'ۇ', 'ە', 'ۋ']
                    result.append('й' if is_vowel else 'и')
                i += 1
                continue
            
            result.append(char)
            i += 1
        
        return ''.join(result)
    
    def convert(self, text: str) -> str:
        """转换文本"""
        text = self.preprocess(text)
        
        # 按行处理，保留段落结构
        lines = text.split('\n')
        converted_lines = []
        
        for line in lines:
            if not line.strip():
                converted_lines.append('')  # 保留空行
                continue
            
            # 处理词组联动：找到阿拉伯文词组并一起转换
            # 匹配连续的阿拉伯文词（包括空格分隔的词组和连字符连接的复合词）
            def convert_match(m):
                phrase = m.group(0)
                # 如果包含空格，使用词组转换
                if ' ' in phrase:
                    return self.convert_phrase(phrase)
                return self.convert_word(phrase)
            
            # 转换阿拉伯文字符（包括空格分隔的词组和连字符连接的复合词）
            result = re.sub(
                r'[\u0600-\u06FF\uFB50-\uFDFF\uFE70-\uFEFF]+(?:[-\s]+[\u0600-\u06FF\uFB50-\uFDFF\uFE70-\uFEFF]+)*',
                convert_match,
                line
            )
            
            # 句首大写
            if result:
                result = result[0].upper() + result[1:]
            
            # 句号、冒号、问号、感叹号后的第一个字母大写
            result = re.sub(
                r'([.。:：?？!！])\s*([а-яәіңғүұқөһ])',
                lambda m: m.group(1) + ' ' + m.group(2).upper(),
                result
            )
            
            # 引号后的第一个字母大写
            result = re.sub(
                r'([«"\'"])\s*([а-яәіңғүұқөһ])',
                lambda m: m.group(1) + m.group(2).upper(),
                result
            )
            
            converted_lines.append(result)
        
        return '\n'.join(converted_lines)

def main():
    """主函数"""
    converter = ArabicToCyrillicConverter()
    
    print("=" * 60)
    print("哈萨克语阿拉伯变体→西里尔文转换器")
    print("Kazakh Arabic Script to Cyrillic Converter")
    print("=" * 60)
    
    # 测试示例
    test_cases = [
        "قازاقستان",
        "سالەم",
        "كىتاپ",
        "مەكتەپ",
        "دوستىق",
        "تاۋەلسىزدىك",
        "وكىز",
        "الىپپە"
    ]
    
    print("\n转换示例：")
    print("-" * 60)
    for test in test_cases:
        converted = converter.convert(test)
        print(f"{test:20} → {converted}")
    
    print("\n" + "=" * 60)
    print("交互模式（输入 'quit' 或 'exit' 退出）")
    print("=" * 60)
    
    while True:
        try:
            text = input("\n请输入阿拉伯文本: ").strip()
            if text.lower() in ('quit', 'exit', ''):
                break
            result = converter.convert(text)
            print(f"转换结果: {result}")
        except KeyboardInterrupt:
            print("\n\n程序已退出")
            break
        except Exception as e:
            print(f"错误: {e}")

if __name__ == '__main__':
    main()
